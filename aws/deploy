#!/bin/sh

cd "$(dirname "$0")"
. ../.env
export AWS_PROFILE
export AWS_REGION

aws cloudformation deploy \
  --template-file template.yml \
  --stack-name ${STACK_NAME} \
  --capabilities CAPABILITY_IAM CAPABILITY_AUTO_EXPAND \
  || exit 1

userPoolId=$(aws cloudformation describe-stack-resource \
  --stack-name ${STACK_NAME} \
  --logical-resource-id UserPool \
  --query StackResourceDetail.PhysicalResourceId \
  --output text)

hostedUIDomain=$(aws cloudformation describe-stack-resource \
  --stack-name ${STACK_NAME} \
  --logical-resource-id UserPoolDomain \
  --query StackResourceDetail.PhysicalResourceId \
  --output text)

userPoolClientId=$(aws cloudformation describe-stack-resource \
  --stack-name ${STACK_NAME} \
  --logical-resource-id UserPoolClient \
  --query StackResourceDetail.PhysicalResourceId \
  --output text)

testApiId=$(aws cloudformation describe-stack-resource \
  --stack-name ${STACK_NAME} \
  --logical-resource-id TestApi \
  --query StackResourceDetail.PhysicalResourceId \
  --output text)

cat <<EOT >../.env.local
# *** DO NOT MODIFY THIS FILE ***
#
# This file is generated by the aws/deploy script. It sets environment variables
# used to configure Amplify in src/main.js. It is automatically read by
# vue-cli-service ("npm run serve")

VUE_APP_AWS_REGION=${AWS_REGION}
VUE_APP_USER_POOL_ID=${userPoolId}
VUE_APP_USER_POOL_CLIENT_ID=${userPoolClientId}
VUE_APP_HOSTED_UI_DOMAIN=${hostedUIDomain}.auth.${AWS_REGION}.amazoncognito.com
VUE_APP_TEST_API_ENDPOINT=https://${testApiId}.execute-api.${AWS_REGION}.amazonaws.com/prod
EOT
